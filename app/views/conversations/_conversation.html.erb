<div class="conversation">

  <div class="conversation-heading">
    <div class="actions">
      <% if conversation.archived? %>
        <%= button_to 'Unarchive', account_conversation_path(@account, @conversation, conversation: { unarchive: true }), method: :patch, class: %w(btn btn-success), form: { id: 'unarchive' } %>
      <% else %>
        <%= button_to 'Archive', account_conversation_path(@account, @conversation, conversation: { archive: true }), method: :patch, class: %w(btn btn-danger), form: { id: 'archive' } %>
      <% end %>
    </div>
    <div class="summary"><%= summary(conversation) %></div>
    <div class="detail">
      #<%= conversation.number %>
    </div>

    <div class="meta">
      <div class="participants">
        <span class="text-muted">With</span>
        <%= conversation.participants.map {|person| nickname(person) }.to_sentence %>
      </div>

      <div class="last-update">
        <span class="text-muted">Most recent message</span>
        <%= time_ago_in_words(conversation.most_recent_message.updated_at) %> ago
      </div>

    </div>
  </div>

  <div class="conversation-body">
    <div class="conversation-stream">
      <% ConversationStream.new(conversation).each do |item| %>
        <div class="conversation-stream-item">
          <% case item %>
          <% when Message %>
            <%= render 'messages/message', message: item %>
          <% when Note %>
            <%= render 'notes/note', note: item %>
          <% end %>
        </div>
      <% end %>

      <div class="conversation-stream-item">
        <%= form_tag account_messages_path(@account), method: 'post', class: 'form-reply' do %>
          <%= hidden_field :message, :conversation_id, value: conversation.id %>

          <div class="person conversation-stream-item-person">
            <%= avatar_default(current_user.person) %>
          </div>

          <%= text_area :message, :content, placeholder: 'Reply to this conversationâ€¦', rows: 4 %>

          <div class="form-actions">
            <div class="btn-group">
              <input class="btn btn-primary" type="submit" name="commit" value="Send &amp; Archive" />
              <input class="btn" type="submit" name="commit" value="Send" />
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <hr>

  <div class="conversation-next">
    <% if @next_conversation %>
      <p class="text-muted text-uppercase">Next Conversation</p>

      <%= render 'row', conversation: @next_conversation %>
    <% else %>
      <p>You made it to the last message!</p>

      <a class="btn btn-primary" href="<%= inbox_account_conversations_path(@account) %>">Back to the Inbox</a>
    <% end %>
  </div>
</div>
